
# xxl-job实现原理

## 如何实现定时任务的触发
> 通过时间轮的机制触发定时任务

## [xxl-job中的时间轮算法](99、中间件场景算法/001、时间轮.md)

可以看到xxl-job中的时间轮算法也是比较有特点的，每次轮询，它的生产数据端`scheduleThread去数据库中读取未来5s`内的任务列表，
然后把它映射到对应的`时间轮`中，供后续的`ringThread去消费`。这个未来5s内应该是xxl-job开发者是有自己的考量，最终定的一个值。

但是注意读取未来的时间间隔不能超过60s，如果超过60s，就会出问题了，可能会存在提前60s去执行某个任务，导致定时任务提前执行了，这是因为时间轮的刻度是60s。

xxl-job的这个时间轮算法最终是可以支持任意的定时时间。

> 时间轮算法可以说是时间定时任务的最佳解决方案了，它也是在很多开源项目中有应用，
> 比如 `Netty`、`Akka`、`Quartz`、`ZooKeeper`、`Kafka` 等组件中都存在时间轮的踪影

## 比如xxl-job，我在执行下次任务之前，如何知道之前的任务执行到什么位置了？

<https://blog.xueqimiao.com/xxl-job/958b10/#%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E>
## 高级配置：
- 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；
  - FIRST（第一个）：固定选择第一个机器； 
  - LAST（最后一个）：固定选择最后一个机器；  
  - ROUND（轮询）：
  - RANDOM（随机）：随机选择在线的机器； 
  - CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。 
  - LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举； 
  - LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举； 
  - FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度； 
  - BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度； 
  - SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务； 
- 
- 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度。 
- 调度过期策略：
- 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；
- 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；
- 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；
  - 单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；
  - 丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；
  - 覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；
- 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；

## xxl-job集群部署时，如何避免多个服务器同时调度任务？
> xxl-job通过mysql悲观锁实现分布式锁，从而避免多个服务器同时调度任务,
```java
 connAutoCommit = conn.getAutoCommit();
 conn.setAutoCommit(false);

 preparedStatement = conn.prepareStatement(  "select * from xxl_job_lock where lock_name = 'schedule_lock' for update" );
 preparedStatement.execute();
```

 ## 避免任务重复执行
(差不多同上解决方案)

调度密集或者耗时任务可能会导致任务阻塞，集群情况下调度组件小概率情况下会重复触发；
针对上述情况，可以通过结合 “单机路由策略（如：第一台、一致性哈希）” + “阻塞策略（如：单机串行、丢弃后续调度）” 来规避，最终避免任务重复执行


## 定时任务是如何实现的
<https://zhuanlan.zhihu.com/p/436447196>



