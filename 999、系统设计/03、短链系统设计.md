
<https://www.zhihu.com/question/29270034/answer/1679116463>

<https://www.cnblogs.com/xiekun/p/12500822.html>

<https://www.bilibili.com/video/BV1dy4y1E7A3?from=search&seid=2003471993190245288&spm_id_from=333.337.0.0>

# 短链系统设计

## 哈希算法
### 通过哈希算法生成短网址

通过过`哈希算法`生成短网址,
我们采用计算速度快、 冲突概率小的 `MurmurHash算法`，

MurmurHash 算法提供了两种长度的哈希值，
一种是 `32bits`， 一种是 `128bits`。
为了让最终生成的短网址尽可能短， 我们可以选择 `32bits`的哈希值。
 
假设经过 MurmurHash 计算后，得到的哈希值就是 181338494 。
我们再拼上短网址服务的域名， 就变成了最终的短网址 http://a.cc/181338494
（其中，http://a.cc 是短网址服务的域名）


### 如何缩短域名？

通过 `MurmurHash` 算法得到的短网址还是很长啊，

我们可以将 `10 进制`的哈希值，转化成`更高进制`的哈希值， 这样哈希值就变短了。

我们知道 `16 进制`中， 我们用 A ～ E 来表示 10 ～ 15

在网址 `URL `中， 常用的合法 字符有 0 ～ 9 、 a ～ z 、 A ～ Z 这样 `62 个字符`。
为了让哈希值表示起来尽可能短，
我们可以将 `10 进制`的哈希值转化成 `62 进制`。

最终用 62 进制表示的短网址就是 http://a.cc/cgSqq

### 如何解决哈希冲突问题?

短链和长连的关系可以用 Redis 或 Mysql存储。


- 将长链（lurl）经过 MurmurHash 后得到短链。

- 再根据短链去`表`中查找看是否存在相关记录，
如果不存在，将长链与短链对应关系插入数据库中，存储。

- 如果存在，说明已经有相关记录了，
此时在`长串`上`拼接一个自定义`好的字段，比如「DUPLICATE」，
然后再对接接的字段串「lurl + DUPLICATE」做第一步操作，如果最后还是重复呢，
再拼一个字段串啊，只要到时根据短链取出长链的时候把这些自定义好的字符串移除即是原来的长链。

以上步骤显然是要优化的，插入一条记录居然要经过`两次 sql 查询`（根据短链查记录，将长短链对应关系插入数据库中），
如果在高并发下，显然会成为`瓶颈`。
 
### 如何优化哈希算法生成短网址的性能?

- 给`短链字段` 加上`唯一索引`
- 如果`违反了唯一性索引`，此时只要给长链再加上我们上文说的自定义字段「DUPLICATE」,
  `重新 hash `再插入即可，看起来在违反唯一性索引的情况下是多执行了步骤，
  但我们要知道 MurmurHash 发生冲突的`概率是非常低的`，基本上不太可能发生，所以这种方案是可以接受的。
- 布隆过滤器来进行优化,如果布隆过滤器不存在则插入。
 

### MurmurHash 实现原理

## 自增序列算法
直接`实现多个 ID 生成器`同时服务。 为了保证每个 ID 生成器生成的 ID 不重复。
要求每个 ID 生成器`按照一定的规则`， 来生成 ID 号码。
比如， 第一个 ID 生成器只能生成尾号为 0 的， 第二个只能生成尾号为 1 的， 以此类推。 
这样通过多个 ID 生成器同时工作， 也提高了 ID 生成的效率。


## 请求短链的高并发架构设计
引入了 openResty

## 短链跳转的基本原理
从上文可知，短链好处多多，那么它是如何工作的呢。我们在浏览器抓下包看看


可以看到请求后，返回了状态码 302（重定向）与 location 值为长链的响应，
然后浏览器会再请求这个长链以得到最终的响应,整个交互流程图如下


主要步骤就是访问短网址后重定向访问 B，那么问题来了，301 和 302 都是重定向，到底该用哪个，
这里需要注意一下 301 和 302 的区别

- 301，代表 `永久重定向`，也就是说第一次请求拿到长链接后，下次浏览器再去请求短链的话，
  `不会向短网址服务器请求`了，而是直接从浏览器的缓存里拿，这样在 server 层面就无法获取到短网址的点击数了，
  如果这个链接刚好是某个活动的链接，也就无法分析此活动的效果。所以我们一般不采用 301。
  
- 302，代表 `临时重定向`，也就是说每次去请求短链都会去请求短网址服务器
  （除非响应中用 Cache-Control 或 Expired 暗示浏览器缓存）,这样就便于 server 统计点击数，
  所以虽然用 302 会给 server 增加一点压力，
  但在数据异常重要的今天，这点代码是值得的，所以推荐使用 302！




