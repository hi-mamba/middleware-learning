## [原文](https://blog.csdn.net/tomato__/article/details/78563001)

# ZooKeeper监听机制

在ZooKeeper中，所有的读操作（getData，getChildren和exists）都可以设置监听。
监听在某些场景下是非常有用的，当你关注某些数据的变化时，如果没有监听，你就只能不断的轮询查看数据是否发生了改变，而监听则可以避免轮询带来的开销。

## 设置监听
ZooKeeper的监听事件仅触发一次，监听事件异步通知客户端，并支持多种监听方式。

仅触发一次 
当数据改变时，一个监听事件被发送到客户端，并取消监听，除非客户端再次设置监听，否则不再监听。 
如果你调用了getData(“/znode1”, true)方法，第二个参数true表示设置监听，后续如果/znode1发生了改变或删除，客户端将收到监听消息。
而如果/znode1再次发生改变，除非客户端执行了另一个设置监听的get操作，否则不会再收到监听消息。
 
- 应用使用ZooKeeper的监听功能的通常方式为： 
  - 1.客户端对特定对象设置监听； 
  - 2.特定对象发生变化，服务端发送监听消息到客户端，并取消监听； 
  - 3.客户端收到监听消息，发起查询，并根据需要决定是否再次监听。 
  ZooKeeper保证查询和监听是一个原子操作，客户端查询数据之后的所有数据变化都能收到监听。

- 发送到客户端   
要求操作必须成功返回到发起操作的客户端后，才能发送通知消息。监听被异步发送给监听者。
ZooKeeper提供了顺序的保证：一个设置了监听的客户端在收到监听事件之前不会看到数据变化。

- 监听方式 
这涉及到数据改变的不同方式，ZooKeeper服务端维护了两个监听队列：数据监听队列和孩子监听队列。
getData()和exists()设置数据监听，getChildren()设置孩子监听。
setData()将触发数据监听，create()将触发一个节点被创建的数据监听和孩子变化的孩子监听，
delete()同样将触发一个数据监听和孩子监听。

监听信息在ZooKeeper的服务端维护，是一个轻量级操作。当一个客户端连接到一个新服务端时，监听将被触发。
在客户端与服务端断开连接后，监听将不能发送到客户端，当客户端重连后，
任何先前的注册监听将自动重新注册并根据情况触发，整个过程自动完成。 
存在一种情况将出现监听事件丢失：当客户端与服务端断开连接期间，一个被监听的节点创建并且被删除，客户端将收不到任何监听事件。 

ZooKeeper服务端的监听列表仅保存在内存中，不做持久化。当一个客户端与服务端断开连接后，
它所有的watch都会从内存中移除，客户端会在重连后自动重新注册它的所有watch。

## 监听事件
ZooKeeper提供了以下几种事件类型，下面描述了监听这些事件的方法：

- Created event：调用exists方法设置监听；
- Deleted event：调用exists、getData、getChildren设置监听；
- Changed event：调用getData设置监听；
- Child event：调用getChildren设置监听。

## 取消监听
客户端能够取消监听，即使连接断开，客户端仍然能够通过设置本地标志来取消监听，取消监听成功后将收到以下事件： 
1. Child Remove event：取消getChildren调用注册的监听成功； 
2. Data Remove event：取消exists和getData调用注册的监听成功。

ZooKeeper对监听提供的保障
关于监听，ZooKeeper提供了以下保障： 
1. 监听是有序的，ZooKeeper客户端库确保事件、监听和异步应答的按序分发； 
1. 客户端在看到一个节点的新数据之前，将先看到该节点的监听事件； 
2. ZooKeeper的监听事件的顺序和ZooKeeper服务查看到的更新的顺序是一致的。

## 注意事项
使用ZooKeeper的监听机制，你需要注意： 

1. 监听仅触发一次；如果你收到了一个监听事件并且想要继续监听，你必须再次设置监听； 

2. 由于监听是一次性的，并且在你收到监听消息和发送一个新请求（再次监听）之间存在延迟，因此你不能保证看到节点的每次改变。
因此你的应用逻辑不应该依赖监听节点的每次变化； 

3. 对于一个通知消息一个监听对象仅会被触发一次。
例如，如果同样的监听对象被同时注册监听exists和getData，当对象被删除时，监听对象将仅被调用一次发送删除通知； 

4. 当客户端和服务端断开连接时（例如服务端挂了），你将不会得到任何监听消息直到连接重建。
由于这个原因，session事件将被发送给所有监听事件处理器，通知他们进入安全模式：在断链期间你将不能接收监听消息，需要谨慎行事。
 