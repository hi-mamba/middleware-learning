## [原文](http://jm.taobao.org/2018/06/13/%E5%81%9A%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%9F/)

# 阿里巴巴为什么不用 ZooKeeper 做服务发现？

著名的CAP理论指出，一个分布式系统不可能同时满足C(一致性)、A(可用性)和P(分区容错性)。
由于分区容错性在是分布式系统中必须要保证的，因此我们只能在A和C之间进行权衡。在此Zookeeper保证的是CP, 而Eureka则是AP。

## Zookeeper保证CP
当向注册中心查询服务列表时，我们可以容忍注册中心返回的是几分钟以前的注册信息，但不能接受服务直接down掉不可用。
也就是说，服务注册功能对可用性的要求要高于一致性。
但是zk会出现这样一种情况，当master节点因为网络故障与其他节点失去联系时，剩余节点会重新进行leader选举。
问题在于，选举leader的时间太长，30 ~ 120s, 且选举期间整个zk集群都是不可用的，这就导致在选举期间注册服务瘫痪。
在云部署的环境下，因网络问题使得zk集群失去master节点是较大概率会发生的事，虽然服务能够最终恢复，
但是漫长的选举时间导致的注册长期不可用是不能容忍的。

##  Eureka保证AP

## Nacos
zookeeper是一种分布式的协调服务，它天生是作为分布式数据一致性场景下的解决方案，所以zookeeper是CP（一致性和分区容错性）,
它牺牲了可用性来保证一致性，在极端情况下（master选举期间）服务会对外停止服务，对于服务可用要求比较高的系统是难以接受的。
Nacos是一种去中心话的架构，属于CAP理论里的AP(可用性和分区容器性)架构，支持最终一致性，
在分布式服务发现与注册场景下具有很不错的性能。
目前dubbo官方也支持使用Nacos代替zookeeper。

而相比Spring Cloud Eureka来说，Nacos更加强大。Nacos=Spring Cloud Eureka + Spring Cloud Config.


##  阿里巴巴为什么不用 ZooKeeper 做服务发现？
在粗粒度分布式锁，分布式选主，主备高可用切换等不需要高TPS 支持的场景下有不可替代的作用，
而这些需求往往多集中在大数据、离线任务等相关的业务领域，因为大数据领域，讲究分割数据集，
并且大部分时间分任务多进程/线程并行处理这些数据集，但是总是有一些点上需要将这些任务和进程统一协调，
这时候就是 ZooKeeper 发挥巨大作用的用武之地。

但是在交易场景交易链路上，在主业务数据存取，大规模服务发现、大规模健康监测等方面有天然的短板，
应该竭力避免在这些场景下引入 ZooKeeper，在阿里巴巴的生产实践中，应用对ZooKeeper申请使用的时候要进行严格的场景、容量、SLA需求的评估。

所以可以使用 ZooKeeper，但是大数据请向左，而交易则向右，分布式协调向左，服务发现向右。

